<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Debug - Final Test</title>
    <style>
        /* Copy key styles from original index.html */
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .sidebar {
            width: 280px;
            background: white;
            padding: 1.5rem 0;
            box-shadow: 2px 0 20px rgba(0,0,0,0.08);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            max-width: none;
        }
        
        .content-header {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: none;
            width: 100%;
        }
        
        .content-body {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            box-sizing: border-box;
            max-width: none;
            width: 100%;
        }
        
        .nav-menu {
            flex: 1;
            padding: 1rem 0;
        }
        
        .nav-item {
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: #64748b;
            position: relative;
            z-index: 10;
            user-select: none;
            pointer-events: auto;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #f1f5f9;
            color: #0ea5e9;
        }
        
        .nav-item:active {
            background: #0ea5e9;
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            font-size: 1.1rem;
        }
        
        .form-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        .form-textarea { resize: vertical; }
        
        .btn {
            background: #0ea5e9;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            background: #0284c7;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .hypothesis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .hypothesis-table th,
        .hypothesis-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .hypothesis-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .hypothesis-item {
            background: #f1f5f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        
        /* Dashboard stats cards */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .priority-high { color: #dc2626; font-weight: bold; }
        .priority-medium { color: #d97706; }
        .priority-low { color: #16a34a; }
        
        /* Debug styles */
        .debug-info {
            position: fixed;
            bottom: 3px;
            right: 3px;
            z-index: 1000;
            max-width: 150px;
            max-height: 60px;
            background: rgba(254, 243, 199, 0.5);
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 4px;
            font-family: monospace;
            font-size: 7px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            overflow-y: auto;
            backdrop-filter: blur(3px);
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-info">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <strong style="font-size: 9px;">üîß Debug</strong>
            <button onclick="toggleDebugPanel()" style="background: #f59e0b; border: none; color: white; border-radius: 3px; padding: 2px 5px; font-size: 8px; cursor: pointer;">‚úï</button>
        </div>
        <div id="debugText" style="font-size: 9px;">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <h2 class="login-title">üìä BI Manager</h2>
            <form class="login-form" id="loginForm">
                <input type="email" class="login-input" id="loginEmail" placeholder="–ò–º–µ–π–ª –∞–¥—Ä–µ—Å" required>
                <input type="password" class="login-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª–∞" required>
                <button type="submit" class="login-btn">–í–ª–∏–∑–∞–Ω–µ</button>
            </form>
            <div class="login-link">
                <a onclick="toggleMode()" id="modeLink">–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –°—ä–∑–¥–∞–π—Ç–µ</a>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <!-- Logo/Title -->
            <div style="padding: 0 1.5rem; margin-bottom: 2rem;">
                <h1 style="color: #0ea5e9; font-size: 1.5rem; margin: 0;">üìä BI Manager</h1>
                <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Business Intelligence</p>
            </div>
            
            <!-- User Info -->
            <div class="user-info" style="padding: 0 1.5rem; margin-bottom: 2rem;">
                <div style="font-size: 0.875rem; color: #64748b;">–í–ª–µ–∑–Ω–∞–ª –∫–∞—Ç–æ:</div>
                <div class="user-email" style="font-weight: 500; color: #374151;">-</div>
                <div class="user-role" style="font-size: 0.875rem; color: #64748b;">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</div>
                <button onclick="signOutUser()" style="margin-top: 10px; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; width: 100%;">
                    üö™ –ò–∑–ª–∏–∑–∞–Ω–µ
                </button>
            </div>
            
            <!-- Navigation -->
            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard', this)">
                    <i class="fas fa-tachometer-alt"></i>
                    –¢–∞–±–ª–æ
                </button>
                <button class="nav-item" onclick="showSection('hypotheses', this)">
                    <i class="fas fa-lightbulb"></i>
                    –•–∏–ø–æ—Ç–µ–∑–∏
                </button>
                <button class="nav-item" onclick="showSection('scenarios', this)">
                    <i class="fas fa-project-diagram"></i>
                    –°—Ü–µ–Ω–∞—Ä–∏–∏
                </button>
                <button class="nav-item" onclick="showSection('analytics', this)">
                    <i class="fas fa-chart-line"></i>
                    –ê–Ω–∞–ª–∏–∑–∏
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="content-header">
                <h1 id="pageTitle">–¢–∞–±–ª–æ</h1>
            </div>
            
            <!-- Content Body -->
            <div class="content-body" id="contentBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBj-FgO7Zhq80QEKC66qk0SXT3iHDMfwao",
            authDomain: "bi-test-working.firebaseapp.com",
            projectId: "bi-test-working",
            storageBucket: "bi-test-working.firebasestorage.app",
            messagingSenderId: "613966052987",
            appId: "1:613966052987:web:81933706980db15784ecde"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Global variables
        window.auth = auth;
        window.currentUser = null;
        window.userRole = null;

        // Notification system
        function createNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            
            const colors = {
                success: { bg: '#10b981', border: '#059669', icon: 'fas fa-check-circle' },
                error: { bg: '#ef4444', border: '#dc2626', icon: 'fas fa-exclamation-triangle' },
                info: { bg: '#3b82f6', border: '#2563eb', icon: 'fas fa-info-circle' }
            };

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="${colors[type].icon}"></i>
                    <span>${message}</span>
                </div>
            `;

            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${colors[type].bg}; color: white; padding: 15px 20px;
                border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px; animation: slideIn 0.3s ease-out;
                border-left: 4px solid ${colors[type].border};
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Sign in with email and password
        async function signIn(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                createNotification('‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–ª–∏–∑–∞–Ω–µ!', 'success');
                return { success: true, user: userCredential.user };
            } catch (error) {
                createNotification(`‚ùå –ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Create user account
        async function createAccount(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                createNotification('‚úÖ –ê–∫–∞—É–Ω—Ç—ä—Ç –µ —Å—ä–∑–¥–∞–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                return { success: true, user: userCredential.user };
            } catch (error) {
                createNotification(`‚ùå –ì—Ä–µ—à–∫–∞: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Sign out
        async function signOutUser() {
            try {
                await signOut(auth);
                createNotification('üëã –£—Å–ø–µ—à–Ω–æ –∏–∑–ª–∏–∑–∞–Ω–µ!', 'info');
            } catch (error) {
                createNotification(`‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ª–∏–∑–∞–Ω–µ: ${error.message}`, 'error');
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if (user) {
                showMainApp();
            } else {
                showLoginScreen();
            }
        });

        // Update user info in UI
        function updateUserInfo(user) {
            const userEmail = document.querySelector('.user-email');
            const userRole = document.querySelector('.user-role');
            if (userEmail) userEmail.textContent = user.email;
            if (userRole) userRole.textContent = '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
        }

        // Show main app
        function showMainApp() {
            const appContainer = document.querySelector('.app-container');
            const loginScreen = document.querySelector('.login-screen');
            if (appContainer) appContainer.style.display = 'flex';
            if (loginScreen) loginScreen.style.display = 'none';
            
            // Update user info if available
            if (window.currentUser) {
                updateUserInfo(window.currentUser);
                updateDebug(`üë§ User logged in: ${window.currentUser.email}`);
                
                // Load initial content
                loadContent('dashboard');
                updateDebug('‚úÖ Initial content loaded');
            }
        }

        // Show login screen
        function showLoginScreen() {
            const appContainer = document.querySelector('.app-container');
            const loginScreen = document.querySelector('.login-screen');
            if (appContainer) appContainer.style.display = 'none';
            if (loginScreen) loginScreen.style.display = 'flex';
            
            updateDebug('üîí Showing login screen');
            
            // Clear form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Make functions available globally
        window.signIn = signIn;
        window.createAccount = createAccount;
        window.signOutUser = signOutUser;
        window.showLoginScreen = showLoginScreen;
        window.showMainApp = showMainApp;
        window.updateUserInfo = updateUserInfo;
        window.toggleMode = toggleMode;
    </script>

    <style>
        /* Login Screen Styles */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; align-items: center; justify-content: center;
            z-index: 9999;
        }
        
        .login-container {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 400px; width: 90%;
        }
        
        .login-title {
            text-align: center; margin-bottom: 30px; color: #333; font-size: 24px;
        }
        
        .login-form {
            display: flex; flex-direction: column; gap: 15px;
        }
        
        .login-input {
            padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px;
            font-size: 16px; transition: border-color 0.3s;
        }
        
        .login-input:focus {
            outline: none; border-color: #667eea;
        }
        
        .login-btn {
            padding: 15px; background: #667eea; color: white; border: none;
            border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: #5a67d8;
        }
        
        .login-link {
            text-align: center; margin-top: 15px;
        }
        
        .login-link a {
            color: #667eea; text-decoration: none; cursor: pointer;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>

    <script>
        // Data storage
        let hypotheses = [];
        let scenarios = [];

        // Debug log function
        function updateDebug(text) {
            const debugDiv = document.getElementById('debugText');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString('bg-BG');
                debugDiv.innerHTML += `<br>[${timestamp}] ${text}`;
                console.log(text);
            }
        }

        // Toggle debug panel
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                updateDebug('üîì Debug panel shown');
            } else {
                panel.style.display = 'none';
            }
        }

        // Navigation function - Direct implementation
        function showSection(sectionName, element) {
            updateDebug(`üñ±Ô∏è Navigation clicked: ${sectionName}`);
            
            try {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                if (element) {
                    element.classList.add('active');
                    updateDebug('‚úÖ Nav item highlighted');
                }

                // Update page title
                const titles = {
                    'dashboard': 'üìä –¢–∞–±–ª–æ',
                    'hypotheses': 'üí° –•–∏–ø–æ—Ç–µ–∑–∏',
                    'scenarios': 'üìã –°—Ü–µ–Ω–∞—Ä–∏–∏',
                    'analytics': 'üìà –ê–Ω–∞–ª–∏–∑–∏'
                };
                
                document.getElementById('pageTitle').textContent = titles[sectionName] || 'BI Manager';
                updateDebug('‚úÖ Page title updated');
                
                // Load content
                loadContent(sectionName);
                
            } catch (error) {
                updateDebug(`‚ùå Error: ${error.message}`);
                console.error('Error in showSection:', error);
            }
        }

        // Load content function
        function loadContent(sectionName) {
            const contentBody = document.getElementById('contentBody');
            
            switch(sectionName) {
                case 'dashboard':
                    contentBody.innerHTML = `
                        <div class="card">
                            <h2>üìä –¢–∞–±–ª–æ</h2>
                            <div class="dashboard-stats">
                                <div class="stat-card">
                                    <div class="stat-number">${hypotheses.length}</div>
                                    <div class="stat-label">üìä –û–±—â–æ —Ö–∏–ø–æ—Ç–µ–∑–∏</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${scenarios.length}</div>
                                    <div class="stat-label">üìã –ê–∫—Ç–∏–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number">${hypotheses.filter(h => h.priority === '–í–∏—Å–æ–∫').length}</div>
                                    <div class="stat-label">üî• –í–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
                                </div>
                            </div>
                            <div class="hypothesis-item">
                                <h3>üéØ –î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ BI Manager!</h3>
                                <p><strong>–ü–æ—Å–ª–µ–¥–Ω–æ –æ–±–Ω–æ–≤–µ–Ω–æ:</strong> ${new Date().toLocaleTimeString('bg-BG')}</p>
                                <p><small>–ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—è—Ç–∞ –≥–æ—Ä–µ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ö–∏–ø–æ—Ç–µ–∑–∏ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.</small></p>
                            </div>
                        </div>
                    `;
                    updateDebug('üìä Dashboard refreshed');
                    break;
                    
                case 'hypotheses':
                    contentBody.innerHTML = `
                        <div class="form-container">
                            <h3>–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∞ —Ö–∏–ø–æ—Ç–µ–∑–∞</h3>
                            <div class="form-group">
                                <label>–ó–∞–≥–ª–∞–≤–∏–µ *</label>
                                <input type="text" id="hypothesisTitle" class="form-input" placeholder="–Ω–∞–ø—Ä. –§–æ–∫—É—Å –≤—ä—Ä—Ö—É –∫–ª–∏–µ–Ω—Ç–∏ 45-55 –≥–æ–¥–∏–Ω–∏">
                            </div>
                            <div class="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                                <textarea id="hypothesisDescription" class="form-textarea" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ö–∏–ø–æ—Ç–µ–∑–∞—Ç–∞..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select id="hypothesisPriority" class="form-select">
                                    <option value="low">–ù–∏—Å—ä–∫</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–µ–Ω</option>
                                    <option value="high">–í–∏—Å–æ–∫</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç</label>
                                <textarea id="hypothesisExpectedResult" class="form-textarea" rows="2" placeholder="–Ω–∞–ø—Ä. 14 –æ—Ç 20 –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ (70% –æ—Ç —Ü–µ–ª—Ç–∞)"></textarea>
                            </div>
                            <div class="form-group">
                                <label>–¶–µ–ª (%)</label>
                                <input type="number" id="hypothesisGoal" class="form-input" placeholder="–Ω–∞–ø—Ä. 70" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>–ú–µ—Ç—Ä–∏–∫–∏</label>
                                <input type="text" id="hypothesisMetrics" class="form-input" placeholder="–Ω–∞–ø—Ä. –ë—Ä–æ–π –ø—Ä–æ–¥–∞–∂–±–∏, Conversion Rate">
                            </div>
                            <div class="form-group">
                                <label>–í—Ä–µ–º–µ–≤–∞ —Ä–∞–º–∫–∞ (–¥–Ω–∏)</label>
                                <input type="number" id="hypothesisTimeframe" class="form-input" placeholder="–Ω–∞–ø—Ä. 30" min="1">
                            </div>
                            <button class="btn" onclick="submitHypothesis()">‚ûï –î–æ–±–∞–≤–∏ —Ö–∏–ø–æ—Ç–µ–∑–∞</button>
                        </div>
                        
                        <div class="card">
                            <h3>–°—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏:</h3>
                            <div id="hypothesesList">
                                <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏.</p>
                            </div>
                        </div>
                    `;
                    renderHypotheses();
                    break;
                    
                case 'scenarios':
                    contentBody.innerHTML = `
                        <div class="form-container">
                            <h3>‚ûï –ù–æ–≤ —Å—Ü–µ–Ω–∞—Ä–∏–π</h3>
                            <div class="form-group">
                                <label>–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è *</label>
                                <input type="text" id="scenarioTitle" class="form-input" placeholder="–Ω–∞–ø—Ä. –†–∞–∑—à–∏—Ä—è–≤–∞–Ω–µ –Ω–∞ –ø–∞–∑–∞—Ä 45-55 –≥–æ–¥–∏–Ω–∏">
                            </div>
                            <div class="form-group">
                                <label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                                <textarea id="scenarioDescription" class="form-textarea" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>–°–≤—ä—Ä–∑–∞–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏</label>
                                <select id="scenarioHypothesis" class="form-select">
                                    <option value="">-- –ò–∑–±–µ—Ä–∏ —Ö–∏–ø–æ—Ç–µ–∑–∞ --</option>
                                    ${hypotheses.map(h => `<option value="${h.id}">${h.title}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select id="scenarioPriority" class="form-select">
                                    <option value="low">–ù–∏—Å—ä–∫</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–µ–Ω</option>
                                    <option value="high">–í–∏—Å–æ–∫</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–°—Ç–∞—Ç—É—Å</label>
                                <select id="scenarioStatus" class="form-select">
                                    <option value="new" selected>–ù–æ–≤</option>
                                    <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å</option>
                                    <option value="completed">–ó–∞–≤—ä—Ä—à–µ–Ω</option>
                                    <option value="on-hold">–ó–∞–º—Ä–∞–∑–µ–Ω</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–æ–≥—Ä–µ—Å (%)</label>
                                <input type="range" id="scenarioProgress" min="0" max="100" value="0" style="width: 100%;">
                                <div style="text-align: center; margin-top: 5px;">
                                    <span id="progressValue">0</span>%
                                </div>
                            </div>
                            <div class="form-group">
                                <label>–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫</label>
                                <input type="date" id="scenarioDeadline" class="form-input">
                            </div>
                            <button class="btn" onclick="submitScenario()">üéØ –°—ä–∑–¥–∞–π —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
                        </div>
                        
                        <div class="card">
                            <h3>üîç –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label>–¢—ä—Ä—Å–µ–Ω–µ:</label>
                                    <input type="text" id="scenarioSearch" class="form-input" placeholder="–¢—ä—Ä—Å–∏ –≤ –∑–∞–≥–ª–∞–≤–∏—è..." oninput="filterScenarios()">
                                </div>
                                <div style="min-width: 150px;">
                                    <label>–°—Ç–∞—Ç—É—Å:</label>
                                    <select id="statusFilter" class="form-select" onchange="filterScenarios()">
                                        <option value="">–í—Å–∏—á–∫–∏</option>
                                        <option value="new">–ù–æ–≤</option>
                                        <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å</option>
                                        <option value="completed">–ó–∞–≤—ä—Ä—à–µ–Ω</option>
                                        <option value="on-hold">–ó–∞–º—Ä–∞–∑–µ–Ω</option>
                                    </select>
                                </div>
                                <div style="min-width: 150px;">
                                    <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                                    <select id="priorityFilter" class="form-select" onchange="filterScenarios()">
                                        <option value="">–í—Å–∏—á–∫–∏</option>
                                        <option value="high">–í–∏—Å–æ–∫</option>
                                        <option value="medium">–°—Ä–µ–¥–µ–Ω</option>
                                        <option value="low">–ù–∏—Å—ä–∫</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="exportScenarios()" style="background: #10b981; margin-right: 10px;">
                                üìä –ï–∫—Å–ø–æ—Ä—Ç
                            </button>
                            <button class="btn" onclick="clearScenarioFilters()" style="background: #64748b;">
                                üîÑ –ò–∑—á–∏—Å—Ç–∏
                            </button>
                        </div>
                        
                        <div class="card">
                            <h3>üìã –°—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h3>
                            <div id="scenariosList">
                                <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Å—ä–∑–¥–∞–¥–µ–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.</p>
                            </div>
                        </div>
                    `;
                    
                    // Setup progress slider
                    const progressSlider = document.getElementById('scenarioProgress');
                    const progressValue = document.getElementById('progressValue');
                    if (progressSlider && progressValue) {
                        progressSlider.addEventListener('input', function() {
                            progressValue.textContent = this.value;
                        });
                    }
                    
                    renderScenarios();
                    break;
                    
                case 'analytics':
                    contentBody.innerHTML = `
                        <div class="card">
                            <h2>üìà –ê–Ω–∞–ª–∏–∑–∏ –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                <div style="background: #e0f2fe; padding: 20px; border-radius: 10px; text-align: center;">
                                    <h4 style="margin: 0; color: #0277bd;">–û–±—â–æ —Ö–∏–ø–æ—Ç–µ–∑–∏</h4>
                                    <div style="font-size: 2rem; font-weight: bold; color: #0277bd;" id="totalHypotheses">${hypotheses.length}</div>
                                </div>
                                <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; text-align: center;">
                                    <h4 style="margin: 0; color: #7b1fa2;">–û–±—â–æ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h4>
                                    <div style="font-size: 2rem; font-weight: bold; color: #7b1fa2;" id="totalScenarios">${scenarios.length}</div>
                                </div>
                                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; text-align: center;">
                                    <h4 style="margin: 0; color: #2e7d32;">–í–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</h4>
                                    <div style="font-size: 2rem; font-weight: bold; color: #2e7d32;" id="highPriorityCount">${hypotheses.filter(h => h.priority === 'high').length}</div>
                                </div>
                                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; text-align: center;">
                                    <h4 style="margin: 0; color: #ef6c00;">–°—Ä–µ–¥–Ω–æ –ø–æ—Å—Ç–∏–≥–Ω–∞—Ç–∏ —Ü–µ–ª–∏</h4>
                                    <div style="font-size: 2rem; font-weight: bold; color: #ef6c00;" id="avgGoal">
                                        ${hypotheses.length > 0 ? Math.round(hypotheses.filter(h => h.goal).reduce((sum, h) => sum + h.goal, 0) / hypotheses.filter(h => h.goal).length || 0) : 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <div class="card">
                                <h3>üìä –•–∏–ø–æ—Ç–µ–∑–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</h3>
                                <canvas id="hypothesisPriorityChart" width="400" height="300"></canvas>
                            </div>
                            
                            <div class="card">
                                <h3>üìà –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å</h3>
                                <canvas id="scenarioStatusChart" width="400" height="300"></canvas>
                            </div>
                            
                            <div class="card">
                                <h3>üéØ –¶–µ–ª–µ–≤–∏ –ø–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                                <canvas id="goalProgressChart" width="400" height="300"></canvas>
                            </div>
                            
                            <div class="card">
                                <h3>üìÖ –¢–∞–π–º–ª–∞–π–Ω –Ω–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ</h3>
                                <canvas id="creationTimelineChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h3>üìã –î–µ—Ç–∞–π–ª–µ–Ω –∞–Ω–∞–ª–∏–∑</h3>
                            <div id="detailedAnalysis">
                                <h4>–¢–æ–ø —Ö–∏–ø–æ—Ç–µ–∑–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</h4>
                                <ul id="topHypotheses">
                                    ${hypotheses
                                        .filter(h => h.priority === 'high')
                                        .map(h => `<li><strong>${h.title}</strong> - –¶–µ–ª: ${h.goal || '–ù/–î'}%</li>`)
                                        .join('') || '<li>–ù—è–º–∞ –≤–∏—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏</li>'}
                                </ul>
                                
                                <h4>–°—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å:</h4>
                                <ul id="inProgressScenarios">
                                    ${scenarios
                                        .filter(s => s.status === 'in-progress')
                                        .map(s => `<li><strong>${s.title}</strong> - –ü—Ä–æ–≥—Ä–µ—Å: ${s.progress || 0}%</li>`)
                                        .join('') || '<li>–ù—è–º–∞ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å</li>'}
                                </ul>
                                
                                <h4>–ü—Ä–µ–ø–æ—Ä—ä–∫–∏:</h4>
                                <ul id="recommendations">
                                    <li>${hypotheses.filter(h => h.priority === 'high').length > 0 ? '–ò–º–∞—Ç–µ ' + hypotheses.filter(h => h.priority === 'high').length + ' –≤–∏—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞' : '–í—Å–∏—á–∫–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ —Å–∞ —Å –Ω–∏—Å—ä–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç'}</li>
                                    <li>${scenarios.filter(s => s.status === 'in-progress').length > 0 ? '–ò–º–∞—Ç–µ ' + scenarios.filter(s => s.status === 'in-progress').length + ' –∞–∫—Ç–∏–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è' : '–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏'}</li>
                                    <li>${hypotheses.filter(h => !h.goal).length > 0 ? '–ò–º–∞ ' + hypotheses.filter(h => !h.goal).length + ' —Ö–∏–ø–æ—Ç–µ–∑–∏ –±–µ–∑ –∑–∞–¥–∞–¥–µ–Ω–∞ —Ü–µ–ª' : '–í—Å–∏—á–∫–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ –∏–º–∞—Ç –∑–∞–¥–∞–¥–µ–Ω–∏ —Ü–µ–ª–∏'}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    // Render charts after DOM is updated
                    setTimeout(() => {
                        renderAnalyticsCharts();
                        updateDebug('üìä Charts rendered successfully');
                        updateDebug(`üìà Stats: ${hypotheses.length} hypotheses, ${scenarios.length} scenarios`);
                    }, 100);
                    break;
            }
            
            updateDebug('‚úÖ Content loaded');
        }

        // Hypothesis functions
        function submitHypothesis() {
            updateDebug('üöÄ submitHypothesis called');
            
            try {
                const title = document.getElementById('hypothesisTitle').value.trim();
                const description = document.getElementById('hypothesisDescription').value.trim();
                const priority = document.getElementById('hypothesisPriority').value;
                const expectedResult = document.getElementById('hypothesisExpectedResult').value.trim();
                const goal = document.getElementById('hypothesisGoal').value;
                const metrics = document.getElementById('hypothesisMetrics').value.trim();
                const timeframe = document.getElementById('hypothesisTimeframe').value;
                
                updateDebug(`üìã Form values: ${title.substring(0,20)}..., ${priority}`);
                
                if (!title || !description) {
                    alert('‚ùå –ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞!');
                    return;
                }
                
                const hypothesis = {
                    id: Date.now(),
                    title: title,
                    description: description,
                    priority: priority,
                    expectedResult: expectedResult,
                    goal: goal ? parseInt(goal) : null,
                    metrics: metrics,
                    timeframe: timeframe ? parseInt(timeframe) : null,
                    author: window.currentUser?.email || 'Unknown',
                    createdAt: new Date().toISOString()
                };
                
                updateDebug('‚úÖ Hypothesis created');
                
                hypotheses.push(hypothesis);
                updateDebug(`üìä Current count: ${hypotheses.length}`);
                
                // Clear form
                document.getElementById('hypothesisTitle').value = '';
                document.getElementById('hypothesisDescription').value = '';
                document.getElementById('hypothesisPriority').value = 'medium';
                document.getElementById('hypothesisExpectedResult').value = '';
                document.getElementById('hypothesisGoal').value = '';
                document.getElementById('hypothesisMetrics').value = '';
                document.getElementById('hypothesisTimeframe').value = '';
                updateDebug('üîÑ Form cleared');
                
                // Update display
                renderHypotheses();
                updateDashboard();
                updateAnalytics();
                updateDebug('üìã Hypotheses rendered');
                updateDebug('üìä Dashboard updated');
                updateDebug('üìà Analytics updated');
                
                alert('‚úÖ –•–∏–ø–æ—Ç–µ–∑–∞—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                
            } catch (error) {
                updateDebug(`‚ùå Error: ${error.message}`);
                console.error('Error adding hypothesis:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ö–∏–ø–æ—Ç–µ–∑–∞!');
            }
        }

        function renderHypotheses() {
            const container = document.getElementById('hypothesesList');
            if (!container) return;
            
            if (hypotheses.length === 0) {
                container.innerHTML = '<p>–í—Å–µ –æ—â–µ –Ω—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏.</p>';
                return;
            }
            
            container.innerHTML = hypotheses.map(h => `
                <div class="hypothesis-item">
                    <h4>${h.title}</h4>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${h.description}</p>
                    ${h.expectedResult ? `<p><strong>–û—á–∞–∫–≤–∞–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç:</strong> ${h.expectedResult}</p>` : ''}
                    ${h.goal ? `<p><strong>–¶–µ–ª:</strong> ${h.goal}%</p>` : ''}
                    ${h.metrics ? `<p><strong>–ú–µ—Ç—Ä–∏–∫–∏:</strong> ${h.metrics}</p>` : ''}
                    ${h.timeframe ? `<p><strong>–í—Ä–µ–º–µ–≤–∞ —Ä–∞–º–∫–∞:</strong> ${h.timeframe} –¥–Ω–∏</p>` : ''}
                    <div style="font-size: 12px; color: #888;">
                        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: <span class="priority-${h.priority}">${getPriorityText(h.priority)}</span> | 
                        –î–∞—Ç–∞: ${formatDate(h.createdAt)}
                    </div>
                </div>
            `).join('');
        }

        function getPriorityText(priority) {
            const priorities = {
                'low': '–ù–∏—Å—ä–∫',
                'medium': '–°—Ä–µ–¥–µ–Ω', 
                'high': '–í–∏—Å–æ–∫'
            };
            return priorities[priority] || priority;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('bg-BG');
        }

        // Update dashboard with current data
        function updateDashboard() {
            // Update the dashboard if it's currently loaded
            const dashboardCard = document.querySelector('.card h2');
            if (dashboardCard && dashboardCard.textContent.includes('üìä')) {
                const contentBody = document.getElementById('contentBody');
                if (contentBody && contentBody.innerHTML.includes('–¢–∞–±–ª–æ')) {
                    // Refresh dashboard content
                    loadContent('dashboard');
                }
            }
        }

        // SCENARIO FUNCTIONS
        function submitScenario() {
            updateDebug('üöÄ submitScenario called');
            
            try {
                const title = document.getElementById('scenarioTitle').value.trim();
                const description = document.getElementById('scenarioDescription').value.trim();
                const hypothesisId = document.getElementById('scenarioHypothesis').value;
                const priority = document.getElementById('scenarioPriority').value;
                const status = document.getElementById('scenarioStatus').value;
                const progress = document.getElementById('scenarioProgress').value;
                const deadline = document.getElementById('scenarioDeadline').value;
                
                updateDebug(`üìã Form values: ${title.substring(0,20)}..., ${priority}, ${status}`);
                
                if (!title || !description) {
                    alert('‚ùå –ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞!');
                    return;
                }
                
                const scenario = {
                    id: Date.now(),
                    title: title,
                    description: description,
                    hypothesisId: hypothesisId ? parseInt(hypothesisId) : null,
                    priority: priority,
                    status: status,
                    progress: parseInt(progress),
                    deadline: deadline || null,
                    author: window.currentUser?.email || 'Unknown',
                    createdAt: new Date().toISOString()
                };
                
                updateDebug('‚úÖ Scenario created');
                
                scenarios.push(scenario);
                updateDebug(`üìä Current scenarios count: ${scenarios.length}`);
                
                // Clear form
                document.getElementById('scenarioTitle').value = '';
                document.getElementById('scenarioDescription').value = '';
                document.getElementById('scenarioHypothesis').value = '';
                document.getElementById('scenarioPriority').value = 'medium';
                document.getElementById('scenarioStatus').value = 'new';
                document.getElementById('scenarioProgress').value = '0';
                document.getElementById('progressValue').textContent = '0';
                document.getElementById('scenarioDeadline').value = '';
                
                updateDebug('üîÑ Form cleared');
                
                // Update display
                renderScenarios();
                updateDebug('üìã Scenarios rendered');
                updateAnalytics();
                updateDebug('üìä Analytics updated');
                
                alert('‚úÖ –°—Ü–µ–Ω–∞—Ä–∏—è—Ç –µ —Å—ä–∑–¥–∞–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                
            } catch (error) {
                updateDebug(`‚ùå Error: ${error.message}`);
                console.error('Error adding scenario:', error);
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π!');
            }
        }

        function renderScenarios() {
            const container = document.getElementById('scenariosList');
            if (!container) return;
            
            if (scenarios.length === 0) {
                container.innerHTML = '<p>–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Å—ä–∑–¥–∞–¥–µ–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.</p>';
                return;
            }
            
            container.innerHTML = scenarios.map(s => {
                const hypothesis = hypotheses.find(h => h.id === s.hypothesisId);
                return `
                    <div class="hypothesis-item" style="border-left-color: ${getStatusColor(s.status)};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4>${s.title}</h4>
                                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${s.description}</p>
                                ${hypothesis ? `<p><strong>–°–≤—ä—Ä–∑–∞–Ω–∞ —Ö–∏–ø–æ—Ç–µ–∑–∞:</strong> ${hypothesis.title}</p>` : ''}
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                                    <span class="priority-${s.priority}">üéØ ${getPriorityText(s.priority)}</span>
                                    <span style="color: ${getStatusColor(s.status)};">üìä ${getStatusText(s.status)}</span>
                                    ${s.deadline ? `<span>üìÖ ${formatDate(s.deadline)}</span>` : ''}
                                </div>
                                ${s.progress >= 0 ? `
                                    <div style="margin: 10px 0;">
                                        <label style="font-size: 12px; color: #666;">–ü—Ä–æ–≥—Ä–µ—Å:</label>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="range" min="0" max="100" value="${s.progress}" 
                                                   onchange="updateScenarioProgress(${s.id}, this.value)" style="flex: 1;">
                                            <span style="font-weight: bold;">${s.progress}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div>
                                <button onclick="deleteScenario(${s.id})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è –ò–∑—Ç—Ä–∏–π
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterScenarios() {
            const searchTerm = document.getElementById('scenarioSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            let filteredScenarios = scenarios;
            
            if (searchTerm) {
                filteredScenarios = filteredScenarios.filter(s => 
                    s.title.toLowerCase().includes(searchTerm) || 
                    s.description.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredScenarios = filteredScenarios.filter(s => s.status === statusFilter);
            }
            
            if (priorityFilter) {
                filteredScenarios = filteredScenarios.filter(s => s.priority === priorityFilter);
            }
            
            const container = document.getElementById('scenariosList');
            if (!container) return;
            
            if (filteredScenarios.length === 0) {
                container.innerHTML = '<p>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.</p>';
                return;
            }
            
            container.innerHTML = filteredScenarios.map(s => {
                const hypothesis = hypotheses.find(h => h.id === s.hypothesisId);
                return `
                    <div class="hypothesis-item" style="border-left-color: ${getStatusColor(s.status)};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4>${s.title}</h4>
                                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${s.description}</p>
                                ${hypothesis ? `<p><strong>–°–≤—ä—Ä–∑–∞–Ω–∞ —Ö–∏–ø–æ—Ç–µ–∑–∞:</strong> ${hypothesis.title}</p>` : ''}
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                                    <span class="priority-${s.priority}">üéØ ${getPriorityText(s.priority)}</span>
                                    <span style="color: ${getStatusColor(s.status)};">üìä ${getStatusText(s.status)}</span>
                                    ${s.deadline ? `<span>üìÖ ${formatDate(s.deadline)}</span>` : ''}
                                </div>
                                ${s.progress >= 0 ? `
                                    <div style="margin: 10px 0;">
                                        <label style="font-size: 12px; color: #666;">–ü—Ä–æ–≥—Ä–µ—Å:</label>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="range" min="0" max="100" value="${s.progress}" 
                                                   onchange="updateScenarioProgress(${s.id}, this.value)" style="flex: 1;">
                                            <span style="font-weight: bold;">${s.progress}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div>
                                <button onclick="deleteScenario(${s.id})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è –ò–∑—Ç—Ä–∏–π
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearScenarioFilters() {
            document.getElementById('scenarioSearch').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            renderScenarios();
        }

        function updateScenarioProgress(scenarioId, newProgress) {
            const scenario = scenarios.find(s => s.id === scenarioId);
            if (scenario) {
                scenario.progress = parseInt(newProgress);
                
                // Auto-update status based on progress
                if (newProgress >= 100) {
                    scenario.status = 'completed';
                } else if (newProgress > 0) {
                    scenario.status = 'in-progress';
                } else {
                    scenario.status = 'new';
                }
                
                renderScenarios();
                updateAnalytics();
            }
        }

        function deleteScenario(scenarioId) {
            if (confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–æ–∑–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π?')) {
                scenarios = scenarios.filter(s => s.id !== scenarioId);
                renderScenarios();
                updateAnalytics();
                alert('‚úÖ –°—Ü–µ–Ω–∞—Ä–∏—è—Ç –µ –∏–∑—Ç—Ä–∏—Ç —É—Å–ø–µ—à–Ω–æ!');
            }
        }

        function exportScenarios() {
            if (scenarios.length === 0) {
                alert('‚ùå –ù—è–º–∞ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!');
                return;
            }
            
            let csv = '–ó–∞–≥–ª–∞–≤–∏–µ,–û–ø–∏—Å–∞–Ω–∏–µ,–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç,–°—Ç–∞—Ç—É—Å,–ü—Ä–æ–≥—Ä–µ—Å,–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫,–ê–≤—Ç–æ—Ä,–î–∞—Ç–∞ –Ω–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ\n';
            
            scenarios.forEach(s => {
                csv += `"${s.title}","${s.description}","${getPriorityText(s.priority)}","${getStatusText(s.status)}","${s.progress}%","${s.deadline ? formatDate(s.deadline) : '–ù/–î'}","${s.author}","${formatDate(s.createdAt)}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scenarios_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–∏—Ç–µ —Å–∞ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ!');
        }

        function getStatusColor(status) {
            const colors = {
                'new': '#3b82f6',
                'in-progress': '#f59e0b',
                'completed': '#10b981',
                'on-hold': '#6b7280'
            };
            return colors[status] || '#3b82f6';
        }

        function getStatusText(status) {
            const texts = {
                'new': '–ù–æ–≤',
                'in-progress': '–í –ø—Ä–æ—Ü–µ—Å',
                'completed': '–ó–∞–≤—ä—Ä—à–µ–Ω',
                'on-hold': '–ó–∞–º—Ä–∞–∑–µ–Ω'
            };
            return texts[status] || status;
        }

        // ANALYTICS FUNCTIONS
        function renderAnalyticsCharts() {
            renderHypothesisPriorityChart();
            renderScenarioStatusChart();
            renderGoalProgressChart();
            renderCreationTimelineChart();
        }

        function renderHypothesisPriorityChart() {
            const ctx = document.getElementById('hypothesisPriorityChart');
            if (!ctx) return;
            
            const priorities = {
                'high': hypotheses.filter(h => h.priority === 'high').length,
                'medium': hypotheses.filter(h => h.priority === 'medium').length,
                'low': hypotheses.filter(h => h.priority === 'low').length
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–í–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–°—Ä–µ–¥–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–ù–∏—Å—ä–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç'],
                    datasets: [{
                        data: [priorities.high, priorities.medium, priorities.low],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderScenarioStatusChart() {
            const ctx = document.getElementById('scenarioStatusChart');
            if (!ctx) return;
            
            const statuses = {
                'new': scenarios.filter(s => s.status === 'new').length,
                'in-progress': scenarios.filter(s => s.status === 'in-progress').length,
                'completed': scenarios.filter(s => s.status === 'completed').length,
                'on-hold': scenarios.filter(s => s.status === 'on-hold').length
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ù–æ–≤', '–í –ø—Ä–æ—Ü–µ—Å', '–ó–∞–≤—ä—Ä—à–µ–Ω', '–ó–∞–º—Ä–∞–∑–µ–Ω'],
                    datasets: [{
                        label: '–ë—Ä–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–∏',
                        data: [statuses.new, statuses['in-progress'], statuses.completed, statuses['on-hold']],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#6b7280'],
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderGoalProgressChart() {
            const ctx = document.getElementById('goalProgressChart');
            if (!ctx) return;
            
            const goalData = hypotheses.filter(h => h.goal);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: goalData.map(h => h.title.substring(0, 20) + '...'),
                    datasets: [{
                        label: '–¶–µ–ª–µ–≤–∏ %',
                        data: goalData.map(h => h.goal),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCreationTimelineChart() {
            const ctx = document.getElementById('creationTimelineChart');
            if (!ctx) return;
            
            // Group hypotheses by date
            const groupedData = {};
            hypotheses.forEach(h => {
                const date = new Date(h.createdAt).toLocaleDateString('bg-BG');
                groupedData[date] = (groupedData[date] || 0) + 1;
            });
            
            const labels = Object.keys(groupedData).sort();
            const data = labels.map(label => groupedData[label]);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–°—ä–∑–¥–∞–¥–µ–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateAnalytics() {
            // Update summary numbers
            const totalHypotheses = document.getElementById('totalHypotheses');
            const totalScenarios = document.getElementById('totalScenarios');
            const highPriorityCount = document.getElementById('highPriorityCount');
            const avgGoal = document.getElementById('avgGoal');
            
            if (totalHypotheses) totalHypotheses.textContent = hypotheses.length;
            if (totalScenarios) totalScenarios.textContent = scenarios.length;
            if (highPriorityCount) highPriorityCount.textContent = hypotheses.filter(h => h.priority === 'high').length;
            
            if (avgGoal && hypotheses.filter(h => h.goal).length > 0) {
                const avg = Math.round(hypotheses.filter(h => h.goal).reduce((sum, h) => sum + h.goal, 0) / hypotheses.filter(h => h.goal).length);
                avgGoal.textContent = avg + '%';
            }
            
            // Update detailed analysis
            updateDetailedAnalysis();
            
            // Re-render charts if analytics section is currently visible
            const analyticsSection = document.querySelector('.card h2');
            if (analyticsSection && analyticsSection.textContent.includes('üìà')) {
                setTimeout(() => {
                    renderAnalyticsCharts();
                }, 100);
            }
        }

        function updateDetailedAnalysis() {
            // Update top hypotheses
            const topHypothesesList = document.getElementById('topHypotheses');
            if (topHypothesesList) {
                const topHypotheses = hypotheses
                    .filter(h => h.priority === 'high')
                    .map(h => `<li><strong>${h.title}</strong> - –¶–µ–ª: ${h.goal || '–ù/–î'}%</li>`)
                    .join('') || '<li>–ù—è–º–∞ –≤–∏—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏</li>';
                topHypothesesList.innerHTML = topHypotheses;
            }
            
            // Update in-progress scenarios
            const inProgressScenariosList = document.getElementById('inProgressScenarios');
            if (inProgressScenariosList) {
                const inProgressScenarios = scenarios
                    .filter(s => s.status === 'in-progress')
                    .map(s => `<li><strong>${s.title}</strong> - –ü—Ä–æ–≥—Ä–µ—Å: ${s.progress || 0}%</li>`)
                    .join('') || '<li>–ù—è–º–∞ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å</li>';
                inProgressScenariosList.innerHTML = inProgressScenarios;
            }
            
            // Update recommendations
            const recommendationsList = document.getElementById('recommendations');
            if (recommendationsList) {
                const recommendations = [
                    `${hypotheses.filter(h => h.priority === 'high').length > 0 ? '–ò–º–∞—Ç–µ ' + hypotheses.filter(h => h.priority === 'high').length + ' –≤–∏—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞' : '–í—Å–∏—á–∫–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ —Å–∞ —Å –Ω–∏—Å—ä–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç'}`,
                    `${scenarios.filter(s => s.status === 'in-progress').length > 0 ? '–ò–º–∞—Ç–µ ' + scenarios.filter(s => s.status === 'in-progress').length + ' –∞–∫—Ç–∏–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è' : '–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏'}`,
                    `${hypotheses.filter(h => !h.goal).length > 0 ? '–ò–º–∞ ' + hypotheses.filter(h => !h.goal).length + ' —Ö–∏–ø–æ—Ç–µ–∑–∏ –±–µ–∑ –∑–∞–¥–∞–¥–µ–Ω–∞ —Ü–µ–ª' : '–í—Å–∏—á–∫–∏ —Ö–∏–ø–æ—Ç–µ–∑–∏ –∏–º–∞—Ç –∑–∞–¥–∞–¥–µ–Ω–∏ —Ü–µ–ª–∏'}`
                ];
                recommendationsList.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
            }
        }

        // Global variables for auth mode
        let isSignUp = false;

        // Initialize
        window.addEventListener('load', function() {
            updateDebug('üöÄ Page loaded successfully');
            
            // Setup login form
            setupLoginForm();
            
            updateDebug('üîß Auth system initialized');
        });

        // Setup login form handling
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLoginSubmit);
            }
        }

        // Handle login form submission
        async function handleLoginSubmit(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            updateDebug(`üîë Attempting ${isSignUp ? 'sign up' : 'sign in'} for: ${email}`);
            
            if (isSignUp) {
                const result = await createAccount(email, password);
                if (result.success) {
                    updateDebug('‚úÖ Account created successfully');
                }
            } else {
                const result = await signIn(email, password);
                if (result.success) {
                    updateDebug('‚úÖ Sign in successful');
                }
            }
        }

        // Toggle between login and signup mode
        function toggleMode() {
            isSignUp = !isSignUp;
            const title = document.querySelector('.login-title');
            const button = document.querySelector('.login-btn');
            const link = document.getElementById('modeLink');
            
            if (isSignUp) {
                title.textContent = 'üìù –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∞–∫–∞—É–Ω—Ç';
                button.textContent = '–°—ä–∑–¥–∞–≤–∞–Ω–µ';
                link.textContent = '–í–µ—á–µ –∏–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –í–ª–µ–∑—Ç–µ';
            } else {
                title.textContent = 'üìä BI Manager';
                button.textContent = '–í–ª–∏–∑–∞–Ω–µ';
                link.textContent = '–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –°—ä–∑–¥–∞–π—Ç–µ';
            }
            
            updateDebug(`üîÑ Mode switched to: ${isSignUp ? 'signup' : 'signin'}`);
        }


    </script>
</body>
</html>